## EPP Dockerfile for Konflux (UBI images)
## This build uses embedded tokenizers from kv-cache (requires Python headers for CGO)
## CGO is required for ZMQ (kvevents) and embedded tokenizer support
## Note: No vLLM/Python runtime dependencies needed, only build-time headers

# Go build stage
FROM registry.access.redhat.com/ubi9/go-toolset:1.24.6 AS go-builder

ARG TARGETOS
ARG TARGETARCH
ARG CGO_ENABLED=1

USER root

# Install Go 1.24.12 to match go.mod toolchain
RUN GO_ARCH=$([ "$TARGETARCH" = "arm64" ] && echo "arm64" || echo "amd64") && \
    curl -L https://go.dev/dl/go1.24.12.linux-${GO_ARCH}.tar.gz -o /tmp/go.tar.gz && \
    rm -rf /usr/local/go && \
    tar -C /usr/local -xzf /tmp/go.tar.gz && \
    rm /tmp/go.tar.gz
ENV PATH="/usr/local/go/bin:${PATH}"
WORKDIR /workspace

# Install ZMQ development libraries (required for CGO)
# Python headers needed because code imports chat_completions (embedded_tokenizers build)
# The builder is based on UBI9, so we need epel-release-9
RUN dnf install -y 'https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm' && \
    dnf install -y zeromq-devel pkgconfig && \
    dnf clean all

# Copy the Go Modules manifests
COPY go.mod go.mod
COPY go.sum go.sum

# Copy the go source
COPY cmd/ cmd/
COPY pkg/ pkg/

RUN go mod download

RUN CGO_ENABLED=${CGO_ENABLED} GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -o bin/epp cmd/epp/main.go

# Runtime stage
# Use ubi9 as a minimal base image to package the manager binary
# Refer to https://catalog.redhat.com/software/containers/ubi9/ubi-minimal/615bd9b4075b022acc111bf5 for more details
FROM registry.access.redhat.com/ubi9/ubi-minimal:9.7

WORKDIR /

# Install ZMQ runtime library only (no Python needed)
RUN curl -L -o /tmp/epel-release.rpm https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm && \
    rpm -i /tmp/epel-release.rpm && \
    rm /tmp/epel-release.rpm && \
    microdnf install -y --setopt=install_weak_deps=0 zeromq && \
    microdnf clean all && \
    rm -rf /var/cache/yum /var/lib/yum

COPY --from=go-builder /workspace/bin/epp /app/epp

USER 1001:1001

# expose gRPC, health and metrics ports
EXPOSE 9002
EXPOSE 9003
EXPOSE 9090
# expose port for KV-Events ZMQ SUB socket
EXPOSE 5557

ENTRYPOINT ["/app/epp"]